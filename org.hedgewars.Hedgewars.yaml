app-id: org.hedgewars.Hedgewars
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: hedgewars
rename-desktop-file: hedgewars.desktop
rename-icon: hedgewars
rename-appdata-file: hedgewars.appdata.xml
finish-args:
  - --socket=x11
  - --share=ipc
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --share=network
  - --persist=.hedgewars
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
modules:
  - shared-modules/glew/glew.json

  - shared-modules/glu/glu-9.json

  - shared-modules/lua5.1/lua-5.1.5.json

  - name: physicsfs
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://www.icculus.org/physfs/downloads/physfs-3.0.2.tar.bz2
        sha256: 304df76206d633df5360e738b138c94e82ccf086e50ba84f456d3f8432f9f863
    cleanup:
      - /bin

  - name: imagemagick
    config-opts:
      - --disable-dependency-tracking
      - --enable-static=no
      - --disable-docs
      - --without-magick-plus-plus
      - --without-bzlib
      - --with-x=no
      - --without-zlib
      - --without-zstd
      - --without-dps
      - --without-fftw
      - --without-flif
      - --without-fpx
      - --without-djvu
      - --without-fontconfig
      - --without-freetype
      - --without-raqm
      - --with-gvc=no
      - --without-heic
      - --without-jbig
      - --without-jpeg
      - --without-lcms
      - --without-openjp2
      - --without-lqr
      - --without-lzma
      - --without-openexr
      - --without-pango
      - --without-raw
      - --without-tiff
      - --without-webp
      - --with-wmf=no
      - --without-xml
    sources:
      - type: archive
        url: https://github.com/ImageMagick/ImageMagick/archive/7.1.0-6.tar.gz
        sha256: 0e925a1e6192bf2908bfcf1a99eec271f36844663ab3b6d2690cdaaa11b928c7
    cleanup:
      - '*'

  - name: numa
    only-arches:
      - aarch64
    sources:
      - type: archive
        url: https://github.com/numactl/numactl/releases/download/v2.0.13/numactl-2.0.13.tar.gz
        sha256: 991e254b867eb5951a44d2ae0bf1996a8ef0209e026911ef6c3ef4caf6f58c9a
    cleanup:
      - /bin

  - name: haskell
    # Using LTS 18.8
    buildsystem: simple
    sources:
      - type: archive
        url: https://downloads.haskell.org/~ghc/8.10.6/ghc-8.10.6-x86_64-deb10-linux.tar.xz
        sha256: 95be925e310b8c419e1099d620a727a1ca2d8c918f33eb905a8221d7eb16467b
        only-arches:
          - x86_64
      - type: archive
        url: https://downloads.haskell.org/~ghc/8.10.6/ghc-8.10.6-aarch64-deb10-linux.tar.xz
        sha256: 1ea27a7776e3cbd0881ecf2eb03eb5176e2cef177a12271a1c33417f4fa48a59
        only-arches:
          - aarch64
      - type: archive
        url: https://downloads.haskell.org/~ghc/8.10.6/ghc-8.10.6-armv7-deb10-linux.tar.xz
        sha256: d54de8306aa8b33afabf2ac94408e1f82c8e982a2a3346168c071b92bdb464c0
        only-arches:
          - arm
    build-commands:
      - ./configure --prefix=/app
      -  make install
    cleanup:
      - '*'

  - name: haskell-primitive
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/primitive-0.7.2.0/primitive-0.7.2.0.tar.gz
        sha256: 9177859782b92b3a096a706c074ec2812bcf75f93f01d1deaac5c2ce05ae4cb9
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-vector
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/vector-0.12.3.0/vector-0.12.3.0.tar.gz
        sha256: 15f818505adda63e7f484ecdf92dbb3c1ec76a9def004c9424db8fa6bc41b703
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-network
    # Old version required by hedgewars
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/network-2.8.0.1/network-2.8.0.1.tar.gz
        sha256: 61f55dbfed0f0af721a8ea36079e9309fcc5a1be20783b44ae500d9e4399a846
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-hashable
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/hashable-1.3.0.0/hashable-1.3.0.0.tar.gz
        sha256: 822e5413fbccca6ae884d3aba4066422c8b5d58d23d18b9ecb5c03273bb19ab4
      - type: shell
        commands:
          - sed -i 's/< *4\.14/<5/' *.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-split
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/split-0.2.3.4/split-0.2.3.4.tar.gz
        sha256: 271fe5104c9f40034aa9a1aad6269bcecc9454bc5a57c247e69e17de996c1f2a
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-unordered-containers
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/unordered-containers-0.2.14.0/unordered-containers-0.2.14.0.tar.gz
        sha256: a10f48a94cef1fab72d2a404c7d541a3cda54ab2f1321872658aca7e5e9d8867
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-vector-algorithms
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/vector-algorithms-0.8.0.4/vector-algorithms-0.8.0.4.tar.gz
        sha256: 76176a56778bf30a275b1089ee6db24ec6c67d92525145f8dfe215b80137af3b
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-mono-traversable
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/mono-traversable-1.0.15.1/mono-traversable-1.0.15.1.tar.gz
        sha256: c2df5b79ed2f88f2ee313e57c1d591d4463788e20d39e439297eec5ba5835ddf
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-unliftio-core
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/unliftio-core-0.2.0.1/unliftio-core-0.2.0.1.tar.gz
        sha256: 919f0d1297ea2f5373118553c1df2a9405d8b9e31a8307e829da67d4953c299a
      - type: shell
        commands:
          - sed -i 's/< *4\.14/<5/' *.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-resourcet
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/resourcet-1.2.4.3/resourcet-1.2.4.3.tar.gz
        sha256: 054152fec5cdc044dd9310c37e548913bcec67ec4e84998a1419a8c067b43b7f
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-conduit
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/conduit-1.3.4.1/conduit-1.3.4.1.tar.gz
        sha256: 85743b8d5f2d5779ccb7459b5a919c5786707af23fe7a065d281ee8e6dc226f1
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-sandi
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/sandi-0.5/sandi-0.5.tar.gz
        sha256: 4940a19fe9c5e9b08a9f139a0806a30b956d007efa973f3763bed3165154afd9
      - type: shell
        commands:
          - echo -e "import Distribution.Simple\nmain = defaultMain" > Setup.hs
    build-commands:
      - runhaskell Setup configure --prefix=/app --extra-lib-dirs=/app/lib
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-old-locale
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/old-locale-1.0.0.7/old-locale-1.0.0.7.tar.gz
        sha256: dbaf8bf6b888fb98845705079296a23c3f40ee2f449df7312f7f7f1de18d7b50
      - type: shell
        commands:
          - sed -i 's/< *4\.9/<5/' *.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-hslogger
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/hslogger-1.3.1.0/hslogger-1.3.1.0.tar.gz
        sha256: 7f2364f6c0b9c5b85a257267a335816126ef2471c817a42797a5d3c57acaca5b
      - type: shell
        commands:
          - sed -i 's/< *4\.14/<5/' *.cabal
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-utf8-string
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/utf8-string-1.0.2/utf8-string-1.0.2.tar.gz
        sha256: ee48deada7600370728c4156cb002441de770d0121ae33a68139a9ed9c19b09a
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-SHA
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/SHA-1.6.4.4/SHA-1.6.4.4.tar.gz
        sha256: 6bd950df6b11a3998bb1452d875d2da043ee43385459afc5f16d471d25178b44
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-entropy
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/entropy-0.4.1.6/entropy-0.4.1.6.tar.gz
        sha256: adc759ff756a6d71a450422ba511177632f43a33bf673901fd2334f53ef8bf62
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-zlib
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/zlib-0.6.2.3/zlib-0.6.2.3.tar.gz
        sha256: 807f6bddf9cb3c517ce5757d991dde3c7e319953a22c86ee03d74534bd5abc88
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-splitmix
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/splitmix-0.1.0.3/splitmix-0.1.0.3.tar.gz
        sha256: 46009f4b000c9e6613377767b8718bf38476469f2a8e2162d98cc246882d5a35
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-random
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/random-1.2.0/random-1.2.0.tar.gz
        sha256: e4519cf7c058bfd5bdbe4acc782284acc9e25e74487208619ca83cbcd63fb9de
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-regex-base
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/regex-base-0.94.0.1/regex-base-0.94.0.1.tar.gz
        sha256: 71b1d96fff201f31fe8cd4532f056aca03a21cd486890256dc3007dd73adedd9
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: haskell-regex-tdfa
    buildsystem: simple
    sources:
      - type: archive
        url: https://hackage.haskell.org/package/regex-tdfa-1.3.1.1/regex-tdfa-1.3.1.1.tar.gz
        sha256: b1be517f6eaaa82bcb733919c58a111ce2acb03cc8fe962b15b64a32c3c059d7
      - type: shell
        commands:
          - echo -e "import Distribution.Simple\nmain = defaultMain" > Setup.hs
    build-commands:
      - runhaskell Setup configure --prefix=/app
      - runhaskell Setup build
      - runhaskell Setup install
    cleanup:
      - '*'

  - name: hedgewars
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_ENGINE_C=1
    post-install:
      - |
        for res in 16 32 48 64 128 256 512; do
          convert +set date:create +set date:modify misc/hedgewars.png -resize ${res}x${res} hedgewars_${res}.png || exit 1
          install -Dm0644 hedgewars_${res}.png /app/share/icons/hicolor/${res}x${res}/apps/hedgewars.png || exit 1
        done
    sources:
      - type: archive
        url: https://github.com/hedgewars/hw/archive/140b82463dec95427b09be817c4ed0ecad72aa7f.zip
        sha256: 0e29183d5b82de77221759ee5eeaee0110be28201fb06623398a06d7d9187c48
      - type: patch
        path: hedgewars-appdata.patch
      - type: shell
        commands:
          - | # Fix compatibility with QT 5.15
            sed -i "/#include <QSizePolicy>/a #include <QPainterPath>" QTfrontend/ui/page/pagegamestats.cpp
          - printf 'rev %s\nhash %s\n' 15438 e7c059ac6e54 >share/version_info.txt
    cleanup:
      - /share/pixmaps
